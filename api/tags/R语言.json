{"name":"R语言","postlist":[{"title":"【转载】用R语言解读凯利公式","slug":"【转载】用R语言解读凯利公式","date":"2024-10-24T03:25:06.000Z","updated":"2024-10-24T05:52:24.678Z","comments":true,"path":"api/articles/【转载】用R语言解读凯利公式.json","excerpt":null,"keywords":"Hexo, 科研, 生物, R语言, 爬虫, 生信, 中药, 果蝇, 笔记, 教程, 虫子, 潜叶虫, leafminer, leaf-miner, 生活, 随笔, 原创","cover":"https://cdn.nlark.com/yuque/0/2024/png/12885947/1712588344529-c6787778-5607-423b-9ba3-654cac0128b7.png","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><div id=\"vip-container\"><p>​<img data-src=\"https://cdn.nlark.com/yuque/0/2024/png/12885947/1712588344529-c6787778-5607-423b-9ba3-654cac0128b7.png\" alt=\"\">​</p>\n<span id=\"more\"></span>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2Jsb2cuZmVucy5tZS9zZXJpZXMtaXQtZmluYW5jZS8=\">用IT技术玩金融系列文章<i class=\"fa fa-external-link-alt\"></i></span>，将介绍如何使用IT技术，处理金融大数据。在互联网混迹多年，已经熟练掌握一些IT技术。单纯地在互联网做开发，总觉得使劲的方式不对。要想靠技术养活自己，就要把技术变现。通过“跨界”可以寻找新的机会，创造技术的壁垒。</p>\n<p>金融是离钱最近的市场，也是变现的好渠道！今天就开始踏上“用IT技术玩金融”之旅！</p>\n<p><strong>关于作者：</strong></p>\n<ul class=\"lvl-1\">\n<li class=\"lvl-2\">\n<p>张丹(Conan), 程序员R,Nodejs,Java</p>\n</li>\n<li class=\"lvl-2\">\n<p>weibo：@Conan_Z</p>\n</li>\n<li class=\"lvl-2\">\n<p>blog: <span class=\"exturl\" data-url=\"aHR0cDovL2Jsb2cuZmVucy5tZS8=\">http://blog.fens.me<i class=\"fa fa-external-link-alt\"></i></span></p>\n</li>\n<li class=\"lvl-2\">\n<p>email: <span class=\"exturl\" data-url=\"bWFpbHRvOmJzc3Bpcml0QGdtYWlsLmNvbQ==\">bsspirit@gmail.com<i class=\"fa fa-external-link-alt\"></i></span></p>\n</li>\n</ul>\n<p><strong>转载请注明出处：</strong><br>\n<span class=\"exturl\" data-url=\"aHR0cDovL2Jsb2cuZmVucy5tZS9maW5hbmNlLWtlbGx5\">http://blog.fens.me/finance-kelly<i class=\"fa fa-external-link-alt\"></i></span></p>\n</blockquote>\n<p>‍</p>\n<p><strong>前言</strong></p>\n<p>职业做投机交易的人，应该都听说过凯利公式，这是一个通过计算胜率和赔率，来选择最佳投注比例的公式，目的是长期获得最高的盈利。</p>\n<p>只要找到长期看必胜的局，接下来就是让时间帮我们赚钱了。</p>\n<h2 id=\"1-开始赌局\">1. 开始赌局</h2>\n<p>设游戏赌局，你赢的概率是80%，输的概率是20%，赢时的净收益率是100%，输时的亏损率也是100%。如果赢，你每赌1元可以赢得1元；如果输，则每赌1元将会输掉1元。赌局可以进行无限次，每次下的赌注可由你自己任意定。如果你的初始资金是100元，那么怎么样下注，才能使得长期收益最大？</p>\n<p>对于胜率80%，从感觉上应该是很有把握的事情了。那么我们先主观判断一次，用90%的仓位去赌一下，看看结果怎么呢？如果下注10次，按80%胜率，8次胜，2次负。我们来算一下最后的结果。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 设置胜负，1胜，0负</span><br><span class=\"line\">&gt; win&lt;-c(1,1,1,0,1,1,0,1,1,1)</span><br><span class=\"line\"> </span><br><span class=\"line\"># 分别按投注计算每回合的剩余资金 </span><br><span class=\"line\">&gt; a1&lt;-(1+0.9)*100</span><br><span class=\"line\">&gt; a2&lt;-a1*(1+0.9)</span><br><span class=\"line\">&gt; a3&lt;-a2*(1+0.9)</span><br><span class=\"line\">&gt; a4&lt;-a3*0.1</span><br><span class=\"line\">&gt; a5&lt;-a4*(1+0.9)</span><br><span class=\"line\">&gt; a6&lt;-a5*(1+0.9)</span><br><span class=\"line\">&gt; a7&lt;-a6*0.1</span><br><span class=\"line\">&gt; a8&lt;-a7*(1+0.9)</span><br><span class=\"line\">&gt; a9&lt;-a8*(1+0.9)</span><br><span class=\"line\">&gt; a10&lt;-a9*(1+0.9)</span><br><span class=\"line\"> </span><br><span class=\"line\">&gt; dat&lt;-c(a1,a2,a3,a4,a5,a6,a7,a8,a9,a10)</span><br><span class=\"line\">&gt; df&lt;-data.frame(win,dat)</span><br><span class=\"line\"></span><br><span class=\"line\"># 打印剩余资金列表</span><br><span class=\"line\">&gt; df</span><br><span class=\"line\">   win      dat</span><br><span class=\"line\">1    1 190.0000</span><br><span class=\"line\">2    1 361.0000</span><br><span class=\"line\">3    1 685.9000</span><br><span class=\"line\">4    0  68.5900</span><br><span class=\"line\">5    1 130.3210</span><br><span class=\"line\">6    1 247.6099</span><br><span class=\"line\">7    0  24.7610</span><br><span class=\"line\">8    1  47.0459</span><br><span class=\"line\">9    1  89.3872</span><br><span class=\"line\">10   1 169.8356</span><br></pre></td></tr></table></figure>\n<p>10次交易后，赢了8次，只输了2次，我们从100元本金，上升到了169元，收益率为69%，还是不错的。最高的时候，资金为685元，收益率为685%，赚了6倍多。最低则是只剩下24元，真是赔的好惨啊！</p>\n<p>接下来，画出资金曲线。这是一个过山车式的曲线，赚钱的时候非常猛，一旦赌输了，就产生了巨大的亏损。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 画出资金曲线 </span><br><span class=\"line\">&gt; plot(df$dat,type=&#x27;l&#x27;)</span><br></pre></td></tr></table></figure>\n<p>​<img data-src=\"https://cdn.nlark.com/yuque/0/2024/png/12885947/1712588344462-88879fa4-2013-4a2b-80ec-d33e03bc4fa7.png\" alt=\"\"><span class=\"exturl\" data-url=\"aHR0cDovL2Jsb2cuZmVucy5tZS93cC1jb250ZW50L3VwbG9hZHMvMjAxOC8wMy8wMS5wbmc=\">http://blog.fens.me/wp-content/uploads/2018/03/01.png<i class=\"fa fa-external-link-alt\"></i></span></p>\n<p>曲线很陡峭，波动很大，回撤也很大，完全就是在赌博。</p>\n<p>怎么样才能让资金曲线好看一些呢？如果每次下注用少一点资金，是不是会更好呢？那么我继续试一下。分别计算每次下注资金为 60%，40%，20%，10%的4个维度的仓位的情况。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; library(magrittr)</span><br><span class=\"line\"></span><br><span class=\"line\"># 定义现金流量函数：win=胜负结果,b=赔率,pos=仓位</span><br><span class=\"line\">&gt; postion&lt;-function(win,b=1,pos=0.6)&#123;            # 省略代码</span><br><span class=\"line\">+ &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"># 设置胜负，1胜，0负</span><br><span class=\"line\">&gt; win&lt;-c(1,1,1,0,1,1,0,1,1,1) </span><br><span class=\"line\">&gt; prob&lt;-0.8                      # 胜率</span><br><span class=\"line\">&gt; n&lt;-10                          # 赌局数</span><br><span class=\"line\">&gt; b&lt;-1                           # 赔率</span><br><span class=\"line\">&gt; caption&lt;-100                   # 金额</span><br><span class=\"line\"> </span><br><span class=\"line\"># 分别计算不同仓位的剩余现金</span><br><span class=\"line\">&gt; pos90&lt;-postion(win,b,0.9)*caption</span><br><span class=\"line\">&gt; pos60&lt;-postion(win,b,0.6)*caption</span><br><span class=\"line\">&gt; pos40&lt;-postion(win,b,0.4)*caption</span><br><span class=\"line\">&gt; pos20&lt;-postion(win,b,0.2)*caption</span><br><span class=\"line\">&gt; pos10&lt;-postion(win,b,0.1)*caption</span><br><span class=\"line\"></span><br><span class=\"line\"># 合并到数据框</span><br><span class=\"line\">&gt; df1&lt;-data.frame(win,pos90,pos60,pos40,pos20,pos10)</span><br><span class=\"line\"></span><br><span class=\"line\"># 打印计算结果</span><br><span class=\"line\">&gt; df1</span><br><span class=\"line\">   win    pos90   pos60   pos40   pos20   pos10</span><br><span class=\"line\">1    1 190.0000 160.000 140.000 120.000 110.000</span><br><span class=\"line\">2    1 361.0000 256.000 196.000 144.000 121.000</span><br><span class=\"line\">3    1 685.9000 409.600 274.400 172.800 133.100</span><br><span class=\"line\">4    0  68.5900 163.840 164.640 138.240 119.790</span><br><span class=\"line\">5    1 130.3210 262.144 230.496 165.888 131.769</span><br><span class=\"line\">6    1 247.6099 419.430 322.694 199.066 144.946</span><br><span class=\"line\">7    0  24.7610 167.772 193.617 159.252 130.451</span><br><span class=\"line\">8    1  47.0459 268.435 271.063 191.103 143.496</span><br><span class=\"line\">9    1  89.3872 429.497 379.489 229.324 157.846</span><br><span class=\"line\">10   1 169.8356 687.195 531.284 275.188 173.631</span><br></pre></td></tr></table></figure>\n<p>我们看到，只是简单地调整了交易的仓位比例，那么交易10次后，你剩余的现是就是有很大的不同的。其中pos60列，即60%仓位的交易，获得的回报最高为687元，而90%的仓位获得的回报，是这里面最少的。而且非常有意思的是，后面的4种仓位设置，每次交易后的资金都大于100元的原始本金。</p>\n<p>画出资金曲线</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; library(ggplot2)</span><br><span class=\"line\">&gt; library(scales)</span><br><span class=\"line\">&gt; library(reshape2)</span><br><span class=\"line\"></span><br><span class=\"line\"># 数据转型 </span><br><span class=\"line\">&gt; df1$num&lt;-1:nrow(df1)</span><br><span class=\"line\">&gt; df&lt;-melt(df1[,-1],id.vars=&quot;num&quot;)</span><br><span class=\"line\"> </span><br><span class=\"line\"># 画图 </span><br><span class=\"line\">&gt; g&lt;-ggplot(df,aes(x=num,y=value,colour=variable ))</span><br><span class=\"line\">&gt; g&lt;-g+geom_line()</span><br><span class=\"line\">&gt; g</span><br></pre></td></tr></table></figure>\n<p>​<img data-src=\"https://cdn.nlark.com/yuque/0/2024/png/12885947/1712588344448-0050ef70-3377-47f6-9d54-5505fb1af9e4.png\" alt=\"\"><span class=\"exturl\" data-url=\"aHR0cDovL2Jsb2cuZmVucy5tZS93cC1jb250ZW50L3VwbG9hZHMvMjAxOC8wMy8wNS5wbmc=\">http://blog.fens.me/wp-content/uploads/2018/03/05.png<i class=\"fa fa-external-link-alt\"></i></span></p>\n<p>从图中可以看到，对于高胜率的情况，大的仓位是可以有高回报的，但是风险也大；小仓位是相对平稳的增长。</p>\n<h2 id=\"2-凯利公式\">2. 凯利公式</h2>\n<p>那么多少的仓位是最优的呢？接下来的问题，就是凯利公式会告诉我们的。</p>\n<p>​<img data-src=\"https://cdn.nlark.com/yuque/0/2024/jpeg/12885947/1712588345313-52f8ea2d-65d1-4255-90bf-948a768b5e60.jpeg\" alt=\"\">​</p>\n<p>在概率论中，凯利公式（The Kelly Criterion）是一个用以使特定赌局中，拥有正期望值之重复行为长期增长率最大化的公式，由约翰·拉里·凯利于1956年在《贝尔系统技术期刊》中发表，可用以计算出每次游戏中应投注的资金比例。</p>\n<p>除可将长期增长率最大化外，此公式不会在任何赌局中，有失去全部现有资金的可能，因此有不存在破产疑虑的优点。公式中，假设货币与赌局可无限分割，只要资金足够多，长期一定是会赚到钱的。</p>\n<p>凯利公式的最一般性陈述为，寻找能最大化结果对数期望值的资本比例f，即可获得长期增长率的最大化。对于只有两种结果的简单赌局而言，即 输失去所有本金，胜获得资金乘以特定的赔率。</p>\n<p>可以用下面公式来表示：</p>\n<p>​<img data-src=\"https://cdn.nlark.com/yuque/0/2024/jpeg/12885947/1712588344600-f8c6da23-61c0-4a8e-b65e-53639a69d53e.jpeg\" alt=\"\"><span class=\"exturl\" data-url=\"aHR0cDovL2Jsb2cuZmVucy5tZS93cC1jb250ZW50L3VwbG9hZHMvMjAxOC8wMy9rZWxseS5qcGc=\">http://blog.fens.me/wp-content/uploads/2018/03/kelly.jpg<i class=\"fa fa-external-link-alt\"></i></span></p>\n<p>其中</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>f* 投注的比例</p>\n</li>\n<li class=\"lvl-2\">\n<p>b 赔率，盈亏比，即平均一次盈利与一次亏损两者的比例</p>\n</li>\n<li class=\"lvl-2\">\n<p>p 胜率</p>\n</li>\n<li class=\"lvl-2\">\n<p>q 败率，即 1 – p</p>\n</li>\n</ul>\n<p>用凯利公式对上面的例子进行测试，胜率p=0.8，失败率q=1-p=0.2，赔率b=1，失败则下注资金完全损失，计算下注比例为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">f* = (b*p-q)/b = (1*0.8-0.2)/1=0.6</span><br></pre></td></tr></table></figure>\n<p>所以，赌客应在每次机会中下注现有资金的60%，可以获得最大化资金的长期增长率。</p>\n<p>通过数学变型，可以很容易得到凯利公式的另一种表达式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Kelly % = W – [(1 – W) / R]</span><br></pre></td></tr></table></figure>\n<p>其中Kelly % 就是上式中的f*，W就是p胜率，R就是b赔率。两者看似不同，其实完全等效一致。</p>\n<p>对于上面的例子，我们可以计算</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Kelly % = W – [(1 – W) / R] = 0.8-[(1-0.8)/1] = 0.6</span><br></pre></td></tr></table></figure>\n<p>凯利公式，有一个优化的变型。如果每次下注失败后，不是全部亏损，只是亏损部分，我们对上面公式可以做一个优化，增加亏损比例参数c，公式改写为下面格式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">f* =  (b*p-c*q)/c*b</span><br></pre></td></tr></table></figure>\n<p>其中</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>f* 投注的比例</p>\n</li>\n<li class=\"lvl-2\">\n<p>b 赔率，盈亏比，即平均一次盈利与一次亏损两者的比例</p>\n</li>\n<li class=\"lvl-2\">\n<p>p 胜率</p>\n</li>\n<li class=\"lvl-2\">\n<p>q 败率，即 1 – p</p>\n</li>\n<li class=\"lvl-2\">\n<p>c 亏损比例</p>\n</li>\n</ul>\n<p>对于上面的例子，如果每次亏损是c=0.8，其他条件不变，那么我们应该用什么仓位进行交易呢？</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">f* = (b*p-q)/b = (1*0.8-0.8*0.2)/(0.8*1)=0.8</span><br></pre></td></tr></table></figure>\n<p>通过计算结果是0.8，我可以增大仓位。</p>\n<p>凯利公式定义了长期获得最高的盈利的仓位确认的计算方法，我们自己也可以按照凯利公式的数学定义，进行推到一下。</p>\n<p>假设一个赌局，每投资1，有p的概率可获得额外正收益W，有q=1-p的概率可获得额外的负收益-L，每次投资比例为x，建立收益为f(x)的目标函数，使得期望收益最大化。</p>\n<p>转化为规划问题：</p>\n<p>​<img data-src=\"https://cdn.nlark.com/yuque/0/2024/png/12885947/1712588346022-8b6d605c-a269-4362-98f7-119d42a8b2f4.png\" alt=\"\"><span class=\"exturl\" data-url=\"aHR0cDovL2Jsb2cuZmVucy5tZS93cC1jb250ZW50L3VwbG9hZHMvMjAxOC8wMy8wMy5wbmc=\">http://blog.fens.me/wp-content/uploads/2018/03/03.png<i class=\"fa fa-external-link-alt\"></i></span></p>\n<p>从推到可看出，标准的凯利公式只是当L=1的情况是一个应用，通过优化可增加了亏损比例参数。</p>\n<h2 id=\"3-赌局的最优解\">3. 赌局的最优解</h2>\n<p>我们已经把公式介绍的很清楚了，那么接下来，就可以用程序实现进行实现了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 凯利公式，实现函数</span><br><span class=\"line\">&gt; kelly&lt;-function(prob,b=1,loss=1)&#123;   # 省略代码</span><br><span class=\"line\">+ &#125;</span><br></pre></td></tr></table></figure>\n<p>用凯利公式计算的上文中的例子。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; prob&lt;-0.8                     # 胜率</span><br><span class=\"line\">&gt; b&lt;-1                          # 赔率</span><br><span class=\"line\">&gt; k&lt;-kelly(prob,b,1);k</span><br><span class=\"line\">[1] 0.6</span><br></pre></td></tr></table></figure>\n<p>这时通过凯利公式，我们就能算出最最优的解其实是0.6的仓位设置，也就可以解释，上面的结果60%的仓位占比，获得的收益是最大的。</p>\n<p>接下来，我们再比较一下不同的胜率和赔率的最优解是什么？</p>\n<p>大胜率和大赔率时，可以重仓。当80%的胜率，2倍赔率时，仓位为70%。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; kelly(0.8,2)</span><br><span class=\"line\">[1] 0.7</span><br></pre></td></tr></table></figure>\n<p>通常情况下的赌局，不足50%的胜率，高赔率时，可以轻仓。当45%的胜率，2倍赔率时，仓位为17.5%。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; kelly(0.45,2)</span><br><span class=\"line\">[1] 0.175</span><br></pre></td></tr></table></figure>\n<p>通常情况下的赌局，不足50%的胜率，低赔率时，不要参考。当45%的胜率，1倍赔率时，不参与赌局。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; kelly(0.45,1)</span><br><span class=\"line\">[1] &quot;Lost!!!&quot;</span><br><span class=\"line\">[1] 0</span><br></pre></td></tr></table></figure>\n<p>小胜率，中等赔率时，不要参与。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; kelly(0.2,1)</span><br><span class=\"line\">[1] &quot;Lost!!!&quot;</span><br><span class=\"line\">[1] 0</span><br></pre></td></tr></table></figure>\n<p>小胜率，中等赔率时，中等损失，不要参与。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; kelly(0.2,1,0.5)</span><br><span class=\"line\">[1] &quot;Lost!!!&quot;</span><br><span class=\"line\">[1] 0</span><br></pre></td></tr></table></figure>\n<p>小胜率，中等赔率时，很小损失，可以All in。很小的损失比例，其实是变相的增大了赔率。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; kelly(0.2,1,0.1)</span><br><span class=\"line\">[1] &quot;All In&quot;</span><br><span class=\"line\">[1] 1</span><br></pre></td></tr></table></figure>\n<p>大胜率，很小赔率，很小损失，All in。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; kelly(0.8,0.1,0.1)</span><br><span class=\"line\">[1] &quot;All In&quot;</span><br><span class=\"line\">[1] 1</span><br></pre></td></tr></table></figure>\n<p>中胜率，很小赔率，很小损失，不要参与。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; kelly(0.45,0.1,0.1)</span><br><span class=\"line\">[1] &quot;Lost!!!&quot;</span><br><span class=\"line\">[1] 0</span><br></pre></td></tr></table></figure>\n<p>总结一下，投机操作的游戏规则。</p>\n<table>\n<thead>\n<tr>\n<th>胜率</th>\n<th>赔率</th>\n<th>损失率</th>\n<th>仓位</th>\n<th>指导建议</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>80%</td>\n<td>2</td>\n<td>100%</td>\n<td>70%</td>\n<td>重仓</td>\n<td>大胜率、大赔率、全部损失</td>\n</tr>\n<tr>\n<td>45%</td>\n<td>2</td>\n<td>100%</td>\n<td>17.5%</td>\n<td>轻仓</td>\n<td>中胜率、大赔率、全部损失</td>\n</tr>\n<tr>\n<td>45%</td>\n<td>1</td>\n<td>100%</td>\n<td>0</td>\n<td>离场</td>\n<td>中胜率、中赔率、全部损失</td>\n</tr>\n<tr>\n<td>20%</td>\n<td>1</td>\n<td>100%</td>\n<td>0</td>\n<td>离场</td>\n<td>小胜率、中赔率、全部损失</td>\n</tr>\n<tr>\n<td>20%</td>\n<td>1</td>\n<td>50%</td>\n<td>0</td>\n<td>离场</td>\n<td>小胜率、中赔率、中等损失</td>\n</tr>\n<tr>\n<td>20%</td>\n<td>1</td>\n<td>10%</td>\n<td>100%</td>\n<td>满仓</td>\n<td>小胜率、中赔率、小损失</td>\n</tr>\n<tr>\n<td>80%</td>\n<td>10%</td>\n<td>10%</td>\n<td>100%</td>\n<td>满仓</td>\n<td>大胜率、小赔率、小损失</td>\n</tr>\n<tr>\n<td>45%</td>\n<td>10%</td>\n<td>10%</td>\n<td>0</td>\n<td>离场</td>\n<td>中胜率、小赔率、小损失</td>\n</tr>\n</tbody>\n</table>\n<p>这样我们就判断出，哪些投机操作值得玩，哪些不能玩，应该怎么玩。是不是很神奇！！</p>\n<h2 id=\"4-让时间帮我们赚钱\">4. 让时间帮我们赚钱</h2>\n<p>根据凯利公式的定义，赌局可以进行无限次，那么当真的把赌局设置为很大时，会是什么情况呢？</p>\n<p>我们把第一次的数据，进行100次的赌局，胜率为80%，赔率为1，金额100元，看一下结果。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; n&lt;-100                          # 赌局数</span><br><span class=\"line\">&gt; prob&lt;-0.8                       # 胜率</span><br><span class=\"line\">&gt; b&lt;-1                            # 赔率</span><br><span class=\"line\">&gt; caption&lt;-100                    # 金额</span><br><span class=\"line\"></span><br><span class=\"line\"># 基本二项分布，生成每盘的赌局正负</span><br><span class=\"line\">&gt; set.seed(1)</span><br><span class=\"line\">&gt; win&lt;-rbinom(n,1,prob)</span><br><span class=\"line\"> </span><br><span class=\"line\"># 生成每盘的资金</span><br><span class=\"line\">&gt; pos90&lt;-postion(win,b,0.9)*caption   # 90%仓位</span><br><span class=\"line\">&gt; pos60&lt;-postion(win,b,0.6)*caption   # 60%仓位</span><br><span class=\"line\">&gt; pos40&lt;-postion(win,b,0.4)*caption   # 40%仓位</span><br><span class=\"line\">&gt; pos20&lt;-postion(win,b,0.2)*caption   # 20%仓位</span><br><span class=\"line\">&gt; pos10&lt;-postion(win,b,0.1)*caption   # 10%仓位</span><br><span class=\"line\"></span><br><span class=\"line\"># 打印数据</span><br><span class=\"line\">&gt; df2&lt;-data.frame(win,pos90,pos60,pos40,pos20,pos10)</span><br><span class=\"line\">&gt; tail(df2)</span><br><span class=\"line\">    win     pos90       pos60       pos40   pos20   pos10</span><br><span class=\"line\">95    1 105083487 5.73375e+11  9874948167 5067085 34506.6</span><br><span class=\"line\">96    1 199658625 9.17399e+11 13824927434 6080503 37957.3</span><br><span class=\"line\">97    1 379351388 1.46784e+12 19354898407 7296603 41753.0</span><br><span class=\"line\">98    1 720767637 2.34854e+12 27096857770 8755924 45928.3</span><br><span class=\"line\">99    0  72076764 9.39417e+11 16258114662 7004739 41335.5</span><br><span class=\"line\">100   1 136945851 1.50307e+12 22761360527 8405687 45469.0</span><br></pre></td></tr></table></figure>\n<p>从100盘赌局后的结果来看，60%的仓位可以获得最高收益的，为1.50307e+12，比其他的仓位都要高少非常。</p>\n<p>接下来，我们生成资金曲线图。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 数据转型</span><br><span class=\"line\">&gt; df2$num&lt;-1:nrow(df2)</span><br><span class=\"line\">&gt; df&lt;-melt(df2[,-1],id.vars = &quot;num&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\"># 画图 </span><br><span class=\"line\">&gt; g&lt;-ggplot(df,aes(x=num,y=value,colour=variable ))</span><br><span class=\"line\">&gt; g&lt;-g+geom_line()</span><br><span class=\"line\">&gt; g&lt;-g+scale_y_log10()  # y坐标轴log化</span><br><span class=\"line\">&gt; g</span><br></pre></td></tr></table></figure>\n<p>​<img data-src=\"https://cdn.nlark.com/yuque/0/2024/png/12885947/1712588346270-a13eaf9e-8ca6-4cea-9c08-e027a1e57107.png\" alt=\"\"><span class=\"exturl\" data-url=\"aHR0cDovL2Jsb2cuZmVucy5tZS93cC1jb250ZW50L3VwbG9hZHMvMjAxOC8wMy8wNi5wbmc=\">http://blog.fens.me/wp-content/uploads/2018/03/06.png<i class=\"fa fa-external-link-alt\"></i></span></p>\n<p>资金曲线图能非常直观地告诉了我们，什么的仓位有什么样曲线形状。你如果追求低风险，就用10%仓位稳健上涨。90%接近满仓并不是最赚钱的，反而是60%的仓位是有最大的回报。</p>\n<p>我们再用凯利公式进行计算，可以发现结果最优的结果也是60%。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; kelly(prob,1)</span><br><span class=\"line\">[1] 0.6</span><br></pre></td></tr></table></figure>\n<p>神奇的算法，可以有效的帮我们控制仓位，最大化长期收益。只要找到长期必胜的局，接下来就是让时间帮我们赚钱了。下一篇文章，将介绍凯利公式在金融市场应用的应用。</p>\n<p>写文章很辛苦，如果需要获得本文源代码或加入量化投资社群，请扫下面二维码，请作者喝杯咖啡。</p>\n<p><strong>转载请注明出处：</strong><br>\n<span class=\"exturl\" data-url=\"aHR0cDovL2Jsb2cuZmVucy5tZS9maW5hbmNlLWtlbGx5\">http://blog.fens.me/finance-kelly<i class=\"fa fa-external-link-alt\"></i></span></p>\n</div>\n\n\t\t\t<script src=\"https://my.openwrite.cn/js/readmore.js\" type=\"text/javascript\"></script>\n\t\t\t<script>\n\t\t\tvar isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);\n\t\t\tif (!isMobile) {\n\t\t\t    var btw = new BTWPlugin();\n\t\t\t    btw.init({\n\t\t\t        \"id\": \"vip-container\",\n\t\t\t        \"blogId\": \"33502-1730425843713-524\",\n\t\t\t        \"name\": \"虫子的生存笔记\",\n\t\t\t        \"qrcode\": \"https://leaf-miner.pages.dev/image/%E5%85%AC%E4%BC%97%E5%8F%B7.png\",\n\t\t\t        \"keyword\": \"more\"\n\t\t\t    });\n\t\t\t}\n\t\t\t</script>\n\t\t","raw":null,"categories":[{"name":"转载","path":"api/categories/转载.json"},{"name":"转载/学习","path":"api/categories/转载/学习.json"}],"tags":[{"name":"R语言","path":"api/tags/R语言.json"},{"name":"金融","path":"api/tags/金融.json"},{"name":"赌博","path":"api/tags/赌博.json"},{"name":"凯利公式","path":"api/tags/凯利公式.json"},{"name":"最佳投注","path":"api/tags/最佳投注.json"}]},{"title":"R语言--果蝇攀爬--ImageJ测量数据处理","slug":"R语言--果蝇攀爬--ImageJ测量数据处理","date":"2024-07-03T06:04:00.000Z","updated":"2024-10-19T08:33:17.188Z","comments":true,"path":"api/articles/R语言--果蝇攀爬--ImageJ测量数据处理.json","excerpt":null,"keywords":"Hexo, 科研, 生物, R语言, 爬虫, 生信, 中药, 果蝇, 笔记, 教程, 虫子, 潜叶虫, leafminer, leaf-miner, 生活, 随笔, 原创","cover":null,"content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><div id=\"vip-container\"><h2 id=\"目的\">目的</h2>\n<p>处理ImageJ测量的果蝇攀爬数据</p>\n<span id=\"more\"></span> \n<h2 id=\"实例\">实例</h2>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>cluster<span class=\"punctuation\">)</span> </span><br><span class=\"line\"><span class=\"comment\"># 设定工作目录</span></span><br><span class=\"line\">setwd<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Desktop/&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 导入数据</span></span><br><span class=\"line\">X20180609_WF_IF <span class=\"operator\">&lt;-</span> read.csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Desktop/20180609-WF-IF.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">X20180609_CM_AM <span class=\"operator\">&lt;-</span> read.csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Desktop/20180609-CM-AM.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">X20180609_CF_AF <span class=\"operator\">&lt;-</span> read.csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Desktop/20180609-CF-AF.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">clusGap<span class=\"punctuation\">(</span>X20180609_WF_IF<span class=\"operator\">$</span>X<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>X20180609_WF_IF<span class=\"operator\">$</span>Slice<span class=\"operator\">==</span><span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span>FUN<span class=\"operator\">=</span>kmeans<span class=\"punctuation\">,</span>nstart<span class=\"operator\">=</span><span class=\"number\">25</span><span class=\"punctuation\">,</span>K.max<span class=\"operator\">=</span><span class=\"number\">10</span><span class=\"punctuation\">,</span>B<span class=\"operator\">=</span><span class=\"number\">500</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">## 自定义函数，获取每管果蝇的攀爬指数----</span></span><br><span class=\"line\">ppindex <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>X<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">g1 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g2 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g3 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g4 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g5 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g6 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> <span class=\"punctuation\">(</span>i <span class=\"keyword\">in</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"built_in\">max</span><span class=\"punctuation\">(</span>X<span class=\"operator\">$</span>Slice<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  slice_x <span class=\"operator\">&lt;-</span> X<span class=\"operator\">$</span>X<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>X<span class=\"operator\">$</span>Slice<span class=\"operator\">==</span>i<span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  slice_y <span class=\"operator\">&lt;-</span> X<span class=\"operator\">$</span>Y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>X<span class=\"operator\">$</span>Slice<span class=\"operator\">==</span>i<span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  slice_max <span class=\"operator\">&lt;-</span> <span class=\"punctuation\">(</span><span class=\"built_in\">max</span><span class=\"punctuation\">(</span>slice_x<span class=\"punctuation\">)</span><span class=\"operator\">+</span><span class=\"number\">100</span><span class=\"punctuation\">)</span><span class=\"operator\">/</span><span class=\"number\">6</span></span><br><span class=\"line\">  par<span class=\"punctuation\">(</span>mfrow <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span><span class=\"number\">6</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"comment\"># 管1</span></span><br><span class=\"line\">  slice_x <span class=\"operator\">&lt;-</span> slice_x<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  slice_y <span class=\"operator\">&lt;-</span> slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  plot<span class=\"punctuation\">(</span>slice_x<span class=\"punctuation\">,</span>slice_y<span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y_fq0 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y <span class=\"operator\">&lt;</span> <span class=\"number\">200</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y_fq1 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y <span class=\"operator\">&gt;</span> <span class=\"number\">200</span><span class=\"operator\">&amp;</span>slice_y <span class=\"operator\">&lt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y_fq2 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y <span class=\"operator\">&gt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"operator\">-</span><span class=\"number\">2</span></span><br><span class=\"line\">  index_1 <span class=\"operator\">&lt;-</span> <span class=\"punctuation\">(</span>slice_y_fq0<span class=\"operator\">*</span><span class=\"number\">0</span><span class=\"operator\">+</span>slice_y_fq1<span class=\"operator\">*</span><span class=\"number\">1</span><span class=\"operator\">+</span>slice_y_fq2<span class=\"operator\">*</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"operator\">/</span><span class=\"punctuation\">(</span>slice_y_fq0<span class=\"operator\">+</span>slice_y_fq1<span class=\"operator\">+</span>slice_y_fq2<span class=\"punctuation\">)</span></span><br><span class=\"line\">  g1 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>g1<span class=\"punctuation\">,</span>index_1<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"comment\"># 管2</span></span><br><span class=\"line\">  slice_x2 <span class=\"operator\">&lt;-</span> slice_x<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_max <span class=\"operator\">&lt;</span> slice_x<span class=\"operator\">&amp;</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"operator\">*</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  slice_y2 <span class=\"operator\">&lt;-</span> slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_max <span class=\"operator\">&lt;</span> slice_x<span class=\"operator\">&amp;</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"operator\">*</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  plot<span class=\"punctuation\">(</span>slice_x2<span class=\"punctuation\">,</span>slice_y2<span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y2_fq0 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y2<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y2 <span class=\"operator\">&lt;</span> <span class=\"number\">200</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y2_fq1 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y2<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y2 <span class=\"operator\">&gt;</span> <span class=\"number\">200</span><span class=\"operator\">&amp;</span>slice_y2 <span class=\"operator\">&lt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y2_fq2 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y2<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y2 <span class=\"operator\">&gt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"operator\">-</span><span class=\"number\">2</span></span><br><span class=\"line\">  index_2 <span class=\"operator\">&lt;-</span> <span class=\"punctuation\">(</span>slice_y2_fq0<span class=\"operator\">*</span><span class=\"number\">0</span><span class=\"operator\">+</span>slice_y2_fq1<span class=\"operator\">*</span><span class=\"number\">1</span><span class=\"operator\">+</span>slice_y2_fq2<span class=\"operator\">*</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"operator\">/</span><span class=\"punctuation\">(</span>slice_y2_fq0<span class=\"operator\">+</span>slice_y2_fq1<span class=\"operator\">+</span>slice_y2_fq2<span class=\"punctuation\">)</span></span><br><span class=\"line\">  g2 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>g2<span class=\"punctuation\">,</span>index_2<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"comment\"># 管3</span></span><br><span class=\"line\">  slice_x3 <span class=\"operator\">&lt;-</span> slice_x<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_max<span class=\"operator\">*</span><span class=\"number\">2</span> <span class=\"operator\">&lt;</span> slice_x<span class=\"operator\">&amp;</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"operator\">*</span><span class=\"number\">3</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  slice_y3 <span class=\"operator\">&lt;-</span> slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_max<span class=\"operator\">*</span><span class=\"number\">2</span> <span class=\"operator\">&lt;</span> slice_x<span class=\"operator\">&amp;</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"operator\">*</span><span class=\"number\">3</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  plot<span class=\"punctuation\">(</span>slice_x3<span class=\"punctuation\">,</span>slice_y3<span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y3_fq0 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y3<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y3 <span class=\"operator\">&lt;</span> <span class=\"number\">200</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y3_fq1 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y3<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y3 <span class=\"operator\">&gt;</span> <span class=\"number\">200</span><span class=\"operator\">&amp;</span>slice_y3 <span class=\"operator\">&lt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y3_fq2 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y3<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y3 <span class=\"operator\">&gt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"operator\">-</span><span class=\"number\">2</span></span><br><span class=\"line\">  index_3 <span class=\"operator\">&lt;-</span> <span class=\"punctuation\">(</span>slice_y3_fq0<span class=\"operator\">*</span><span class=\"number\">0</span><span class=\"operator\">+</span>slice_y3_fq1<span class=\"operator\">*</span><span class=\"number\">1</span><span class=\"operator\">+</span>slice_y3_fq2<span class=\"operator\">*</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"operator\">/</span><span class=\"punctuation\">(</span>slice_y3_fq0<span class=\"operator\">+</span>slice_y3_fq1<span class=\"operator\">+</span>slice_y3_fq2<span class=\"punctuation\">)</span></span><br><span class=\"line\">  g3 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>g3<span class=\"punctuation\">,</span>index_3<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"comment\"># 管4</span></span><br><span class=\"line\">  slice_x4 <span class=\"operator\">&lt;-</span> slice_x<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_max<span class=\"operator\">*</span><span class=\"number\">3</span> <span class=\"operator\">&lt;</span> slice_x<span class=\"operator\">&amp;</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"operator\">*</span><span class=\"number\">4</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  slice_y4 <span class=\"operator\">&lt;-</span> slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_max<span class=\"operator\">*</span><span class=\"number\">3</span> <span class=\"operator\">&lt;</span> slice_x<span class=\"operator\">&amp;</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"operator\">*</span><span class=\"number\">4</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  plot<span class=\"punctuation\">(</span>slice_x4<span class=\"punctuation\">,</span>slice_y4<span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y4_fq0 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y4<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y4 <span class=\"operator\">&lt;</span> <span class=\"number\">200</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y4_fq1 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y4<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y4 <span class=\"operator\">&gt;</span> <span class=\"number\">200</span><span class=\"operator\">&amp;</span>slice_y4 <span class=\"operator\">&lt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y4_fq2 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y4<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y4 <span class=\"operator\">&gt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"operator\">-</span><span class=\"number\">2</span></span><br><span class=\"line\">  index_4 <span class=\"operator\">&lt;-</span> <span class=\"punctuation\">(</span>slice_y4_fq0<span class=\"operator\">*</span><span class=\"number\">0</span><span class=\"operator\">+</span>slice_y4_fq1<span class=\"operator\">*</span><span class=\"number\">1</span><span class=\"operator\">+</span>slice_y4_fq2<span class=\"operator\">*</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"operator\">/</span><span class=\"punctuation\">(</span>slice_y4_fq0<span class=\"operator\">+</span>slice_y4_fq1<span class=\"operator\">+</span>slice_y4_fq2<span class=\"punctuation\">)</span></span><br><span class=\"line\">  g4 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>g4<span class=\"punctuation\">,</span>index_4<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"comment\"># 管5</span></span><br><span class=\"line\">  slice_x5 <span class=\"operator\">&lt;-</span> slice_x<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_max<span class=\"operator\">*</span><span class=\"number\">4</span> <span class=\"operator\">&lt;</span> slice_x<span class=\"operator\">&amp;</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"operator\">*</span><span class=\"number\">5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  slice_y5 <span class=\"operator\">&lt;-</span> slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_max<span class=\"operator\">*</span><span class=\"number\">4</span> <span class=\"operator\">&lt;</span> slice_x<span class=\"operator\">&amp;</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"operator\">*</span><span class=\"number\">5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  plot<span class=\"punctuation\">(</span>slice_x5<span class=\"punctuation\">,</span>slice_y5<span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y5_fq0 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y5<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y5 <span class=\"operator\">&lt;</span> <span class=\"number\">200</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y5_fq1 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y5<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y5 <span class=\"operator\">&gt;</span> <span class=\"number\">200</span><span class=\"operator\">&amp;</span>slice_y5 <span class=\"operator\">&lt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y5_fq2 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y5<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y5 <span class=\"operator\">&gt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"operator\">-</span><span class=\"number\">2</span></span><br><span class=\"line\">  index_5 <span class=\"operator\">&lt;-</span> <span class=\"punctuation\">(</span>slice_y5_fq0<span class=\"operator\">*</span><span class=\"number\">0</span><span class=\"operator\">+</span>slice_y5_fq1<span class=\"operator\">*</span><span class=\"number\">1</span><span class=\"operator\">+</span>slice_y5_fq2<span class=\"operator\">*</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"operator\">/</span><span class=\"punctuation\">(</span>slice_y5_fq0<span class=\"operator\">+</span>slice_y5_fq1<span class=\"operator\">+</span>slice_y5_fq2<span class=\"punctuation\">)</span></span><br><span class=\"line\">  g5 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>g5<span class=\"punctuation\">,</span>index_5<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"comment\"># 管6</span></span><br><span class=\"line\">  slice_x6 <span class=\"operator\">&lt;-</span> slice_x<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_max<span class=\"operator\">*</span><span class=\"number\">5</span> <span class=\"operator\">&lt;</span> slice_x<span class=\"operator\">&amp;</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"operator\">*</span><span class=\"number\">6</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  slice_y6 <span class=\"operator\">&lt;-</span> slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_max<span class=\"operator\">*</span><span class=\"number\">5</span> <span class=\"operator\">&lt;</span> slice_x<span class=\"operator\">&amp;</span>slice_x <span class=\"operator\">&lt;</span> slice_max<span class=\"operator\">*</span><span class=\"number\">6</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  plot<span class=\"punctuation\">(</span>slice_x6<span class=\"punctuation\">,</span>slice_y6<span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y6_fq0 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y6<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y6 <span class=\"operator\">&lt;</span> <span class=\"number\">200</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y6_fq1 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y6<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y6 <span class=\"operator\">&gt;</span> <span class=\"number\">200</span><span class=\"operator\">&amp;</span>slice_y6 <span class=\"operator\">&lt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  slice_y6_fq2 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y6<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y6 <span class=\"operator\">&gt;</span> <span class=\"number\">400</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"operator\">-</span><span class=\"number\">2</span></span><br><span class=\"line\">  index_6 <span class=\"operator\">&lt;-</span> <span class=\"punctuation\">(</span>slice_y6_fq0<span class=\"operator\">*</span><span class=\"number\">0</span><span class=\"operator\">+</span>slice_y6_fq1<span class=\"operator\">*</span><span class=\"number\">1</span><span class=\"operator\">+</span>slice_y6_fq2<span class=\"operator\">*</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"operator\">/</span><span class=\"punctuation\">(</span>slice_y6_fq0<span class=\"operator\">+</span>slice_y6_fq1<span class=\"operator\">+</span>slice_y6_fq2<span class=\"punctuation\">)</span></span><br><span class=\"line\">  g6 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>g6<span class=\"punctuation\">,</span>index_6<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  flyindex <span class=\"operator\">&lt;-</span> data.frame<span class=\"punctuation\">(</span>g1<span class=\"punctuation\">,</span>g2<span class=\"punctuation\">,</span>g3<span class=\"punctuation\">,</span>g4<span class=\"punctuation\">,</span>g5<span class=\"punctuation\">,</span>g6<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"built_in\">return</span><span class=\"punctuation\">(</span>flyindex<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#汇总----</span></span><br><span class=\"line\">WI_F_Index <span class=\"operator\">&lt;-</span> ppindex<span class=\"punctuation\">(</span>X20180609_WF_IF<span class=\"punctuation\">)</span> </span><br><span class=\"line\"><span class=\"built_in\">names</span><span class=\"punctuation\">(</span>WI_F_Index<span class=\"punctuation\">)</span> <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;WF1&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;WF2&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;WF3&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;IF1&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;IF2&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;IF3&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">WI_F_Index <span class=\"operator\">&lt;-</span> ppindex<span class=\"punctuation\">(</span>X20180609_CF_AF<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"built_in\">names</span><span class=\"punctuation\">(</span>CA_F_Index<span class=\"punctuation\">)</span> <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;CF1&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;CF2&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;CF3&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;AF1&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;AF2&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;AF3&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">CA_M_Index <span class=\"operator\">&lt;-</span> ppindex<span class=\"punctuation\">(</span>X20180609_CM_AM<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"built_in\">names</span><span class=\"punctuation\">(</span>CA_M_Index<span class=\"punctuation\">)</span> <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;CM1&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;CM2&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;CM3&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;AM1&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;AM2&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot;AM3&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 保存</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>xlsx<span class=\"punctuation\">)</span></span><br><span class=\"line\">write.xlsx2<span class=\"punctuation\">(</span>WI_F_Index<span class=\"punctuation\">,</span> sheetName <span class=\"operator\">=</span> <span class=\"string\">&quot;WI_F_Index&quot;</span><span class=\"punctuation\">,</span> file<span class=\"operator\">=</span><span class=\"string\">&#x27;flyIndex.xlsx&#x27;</span><span class=\"punctuation\">,</span>append <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">write.xlsx2<span class=\"punctuation\">(</span>CA_F_Index<span class=\"punctuation\">,</span> sheetName <span class=\"operator\">=</span> <span class=\"string\">&quot;CA_F_Index&quot;</span><span class=\"punctuation\">,</span> file<span class=\"operator\">=</span><span class=\"string\">&#x27;flyIndex.xlsx&#x27;</span><span class=\"punctuation\">,</span>append <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">write.xlsx2<span class=\"punctuation\">(</span>CA_M_Index<span class=\"punctuation\">,</span> sheetName <span class=\"operator\">=</span> <span class=\"string\">&quot;CA_M_Index&quot;</span><span class=\"punctuation\">,</span> file<span class=\"operator\">=</span><span class=\"string\">&#x27;flyIndex.xlsx&#x27;</span><span class=\"punctuation\">,</span>append <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">###########################################################################################</span></span><br><span class=\"line\"><span class=\"comment\">#单管----</span></span><br><span class=\"line\"><span class=\"comment\"># 导入数据</span></span><br><span class=\"line\">X20180609_IM3 <span class=\"operator\">&lt;-</span> read.csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Desktop/20180609-IM3.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">X20180609_IM2 <span class=\"operator\">&lt;-</span> read.csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Desktop/20180609-IM2.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">X20180609_IM1 <span class=\"operator\">&lt;-</span> read.csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Desktop/20180609-IM1.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">X20180609_WM3 <span class=\"operator\">&lt;-</span> read.csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Desktop/20180609-WM3.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">X20180609_WM2 <span class=\"operator\">&lt;-</span> read.csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Desktop/20180609-WM2.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">X20180609_WM1 <span class=\"operator\">&lt;-</span> read.csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Desktop/20180609-WM1.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pp2index <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  index <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> <span class=\"punctuation\">(</span>i <span class=\"keyword\">in</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"built_in\">max</span><span class=\"punctuation\">(</span>x<span class=\"operator\">$</span>Slice<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    slice_x <span class=\"operator\">&lt;-</span> x<span class=\"operator\">$</span>X<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>x<span class=\"operator\">$</span>Slice <span class=\"operator\">==</span> i<span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">    slice_y <span class=\"operator\">&lt;-</span> x<span class=\"operator\">$</span>Y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>x<span class=\"operator\">$</span>Slice <span class=\"operator\">==</span> i<span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">    slice_y_fq0 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y <span class=\"operator\">&lt;</span> <span class=\"number\">340</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    slice_y_fq1 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y <span class=\"operator\">&gt;</span> <span class=\"number\">340</span> <span class=\"operator\">&amp;</span></span><br><span class=\"line\">                                          slice_y <span class=\"operator\">&lt;</span> <span class=\"number\">600</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"punctuation\">(</span><span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y <span class=\"operator\">&gt;</span> <span class=\"number\">600</span> <span class=\"operator\">&amp;</span></span><br><span class=\"line\">                              slice_y <span class=\"operator\">&lt;</span> <span class=\"number\">900</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span> <span class=\"operator\">-</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">&lt;</span> <span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      slice_y_fq2 <span class=\"operator\">&lt;-</span> 0</span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      slice_y_fq2 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y <span class=\"operator\">&gt;</span> <span class=\"number\">600</span> <span class=\"operator\">&amp;</span></span><br><span class=\"line\">                                            slice_y <span class=\"operator\">&lt;</span> <span class=\"number\">900</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span> <span class=\"operator\">-</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"punctuation\">(</span><span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y <span class=\"operator\">&gt;</span> <span class=\"number\">900</span> <span class=\"operator\">&amp;</span></span><br><span class=\"line\">                              slice_y <span class=\"operator\">&lt;</span> <span class=\"number\">1200</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span> <span class=\"operator\">-</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">&lt;</span> <span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      slice_y_fq3 <span class=\"operator\">&lt;-</span> 0</span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      slice_y_fq3 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y <span class=\"operator\">&gt;</span> <span class=\"number\">900</span> <span class=\"operator\">&amp;</span></span><br><span class=\"line\">                                            slice_y <span class=\"operator\">&lt;</span> <span class=\"number\">1200</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span> <span class=\"operator\">-</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"punctuation\">(</span><span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y <span class=\"operator\">&gt;</span> <span class=\"number\">1200</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span> <span class=\"operator\">-</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">&lt;</span> <span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      slice_y_fq4 <span class=\"operator\">&lt;-</span> 0</span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      slice_y_fq4 <span class=\"operator\">&lt;-</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>slice_y<span class=\"punctuation\">[</span>which<span class=\"punctuation\">(</span>slice_y <span class=\"operator\">&gt;</span> <span class=\"number\">1200</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span> <span class=\"operator\">-</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    index_1 <span class=\"operator\">&lt;-</span> <span class=\"punctuation\">(</span>slice_y_fq0 <span class=\"operator\">*</span> <span class=\"number\">0</span> <span class=\"operator\">+</span> slice_y_fq1 <span class=\"operator\">*</span> <span class=\"number\">1</span> <span class=\"operator\">+</span> slice_y_fq2 <span class=\"operator\">*</span> <span class=\"number\">2</span> <span class=\"operator\">+</span> slice_y_fq3 <span class=\"operator\">*</span></span><br><span class=\"line\">                  <span class=\"number\">3</span> <span class=\"operator\">+</span> slice_y_fq4 <span class=\"operator\">*</span> <span class=\"number\">4</span><span class=\"punctuation\">)</span> <span class=\"operator\">/</span> <span class=\"punctuation\">(</span>slice_y_fq0 <span class=\"operator\">+</span> slice_y_fq1 <span class=\"operator\">+</span> slice_y_fq2 <span class=\"operator\">+</span> slice_y_fq3 <span class=\"operator\">+</span></span><br><span class=\"line\">                                            slice_y_fq4<span class=\"punctuation\">)</span></span><br><span class=\"line\">    index <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>index<span class=\"punctuation\">,</span>index_1<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"built_in\">return</span><span class=\"punctuation\">(</span>index<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">IM3 <span class=\"operator\">&lt;-</span> pp2index<span class=\"punctuation\">(</span>X20180609_IM3<span class=\"punctuation\">)</span></span><br><span class=\"line\">IM2 <span class=\"operator\">&lt;-</span> pp2index<span class=\"punctuation\">(</span>X20180609_IM2<span class=\"punctuation\">)</span></span><br><span class=\"line\">IM1 <span class=\"operator\">&lt;-</span> pp2index<span class=\"punctuation\">(</span>X20180609_IM1<span class=\"punctuation\">)</span></span><br><span class=\"line\">WM1 <span class=\"operator\">&lt;-</span> pp2index<span class=\"punctuation\">(</span>X20180609_WM1<span class=\"punctuation\">)</span></span><br><span class=\"line\">WM2 <span class=\"operator\">&lt;-</span> pp2index<span class=\"punctuation\">(</span>X20180609_WM3<span class=\"punctuation\">)</span></span><br><span class=\"line\">WM3 <span class=\"operator\">&lt;-</span> pp2index<span class=\"punctuation\">(</span>X20180609_WM2<span class=\"punctuation\">)</span></span><br><span class=\"line\">WI_M_Index <span class=\"operator\">&lt;-</span> cbind<span class=\"punctuation\">(</span>WM1<span class=\"operator\">=</span>WM1<span class=\"punctuation\">,</span>WM2<span class=\"operator\">=</span>WM2<span class=\"punctuation\">,</span>WM3<span class=\"operator\">=</span>WM3<span class=\"punctuation\">,</span>IM1<span class=\"operator\">=</span>IM1<span class=\"punctuation\">,</span>IM2<span class=\"operator\">=</span>IM2<span class=\"punctuation\">,</span>IM3<span class=\"operator\">=</span>IM3<span class=\"punctuation\">)</span></span><br><span class=\"line\">write.xlsx2<span class=\"punctuation\">(</span>WI_M_Index<span class=\"punctuation\">,</span> sheetName <span class=\"operator\">=</span> <span class=\"string\">&quot;WI_M_Index&quot;</span><span class=\"punctuation\">,</span> file<span class=\"operator\">=</span><span class=\"string\">&#x27;flyIndex.xlsx&#x27;</span><span class=\"punctuation\">,</span>append <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></div>\n\n\t\t\t<script src=\"https://my.openwrite.cn/js/readmore.js\" type=\"text/javascript\"></script>\n\t\t\t<script>\n\t\t\tvar isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);\n\t\t\tif (!isMobile) {\n\t\t\t    var btw = new BTWPlugin();\n\t\t\t    btw.init({\n\t\t\t        \"id\": \"vip-container\",\n\t\t\t        \"blogId\": \"33502-1730425843713-524\",\n\t\t\t        \"name\": \"虫子的生存笔记\",\n\t\t\t        \"qrcode\": \"https://leaf-miner.pages.dev/image/%E5%85%AC%E4%BC%97%E5%8F%B7.png\",\n\t\t\t        \"keyword\": \"more\"\n\t\t\t    });\n\t\t\t}\n\t\t\t</script>\n\t\t","raw":null,"categories":[{"name":"原创","path":"api/categories/原创.json"},{"name":"原创/科研","path":"api/categories/原创/科研.json"}],"tags":[{"name":"ImageJ","path":"api/tags/ImageJ.json"},{"name":"R语言","path":"api/tags/R语言.json"},{"name":"批量","path":"api/tags/批量.json"},{"name":"实例","path":"api/tags/实例.json"},{"name":"数据处理","path":"api/tags/数据处理.json"},{"name":"果蝇","path":"api/tags/果蝇.json"}]},{"title":"R语言--批量解压文件--示例","slug":"R语言--批量解压文件","date":"2024-05-23T08:40:00.000Z","updated":"2024-10-19T08:33:27.269Z","comments":true,"path":"api/articles/R语言--批量解压文件.json","excerpt":null,"keywords":"Hexo, 科研, 生物, R语言, 爬虫, 生信, 中药, 果蝇, 笔记, 教程, 虫子, 潜叶虫, leafminer, leaf-miner, 生活, 随笔, 原创","cover":null,"content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><div id=\"vip-container\"><h2 id=\"目的\">目的</h2>\n<p>用R语言批量解压文件到指定目录</p>\n<span id=\"more\"></span> \n<h2 id=\"实例\">实例</h2>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidyverse<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># 工作文件夹</span></span><br><span class=\"line\">setwd<span class=\"punctuation\">(</span><span class=\"string\">&quot;I:\\\\果蝇锻炼\\\\201803-不同浓度枸杞攀爬拍照&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 压缩文件列表</span></span><br><span class=\"line\">filelist <span class=\"operator\">&lt;-</span> dir<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">ziplist <span class=\"operator\">&lt;-</span>  filelist<span class=\"punctuation\">[</span>grepl<span class=\"punctuation\">(</span><span class=\"string\">&quot;zip&quot;</span><span class=\"punctuation\">,</span>filelist<span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 循环解压到指定文件夹</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> <span class=\"punctuation\">(</span>i <span class=\"keyword\">in</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"built_in\">length</span><span class=\"punctuation\">(</span>ziplist<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  unzip<span class=\"punctuation\">(</span>ziplist<span class=\"punctuation\">[</span>i<span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> exdir <span class=\"operator\">=</span> paste0<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:\\\\Desktop\\\\Fly-climb\\\\&quot;</span><span class=\"punctuation\">,</span>substr<span class=\"punctuation\">(</span>ziplist<span class=\"punctuation\">[</span>i<span class=\"punctuation\">]</span><span class=\"punctuation\">,</span><span class=\"number\">1</span><span class=\"punctuation\">,</span>str_length<span class=\"punctuation\">(</span>ziplist<span class=\"punctuation\">[</span>i<span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"operator\">-</span><span class=\"number\">4</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure></div>\n\n\t\t\t<script src=\"https://my.openwrite.cn/js/readmore.js\" type=\"text/javascript\"></script>\n\t\t\t<script>\n\t\t\tvar isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);\n\t\t\tif (!isMobile) {\n\t\t\t    var btw = new BTWPlugin();\n\t\t\t    btw.init({\n\t\t\t        \"id\": \"vip-container\",\n\t\t\t        \"blogId\": \"33502-1730425843713-524\",\n\t\t\t        \"name\": \"虫子的生存笔记\",\n\t\t\t        \"qrcode\": \"https://leaf-miner.pages.dev/image/%E5%85%AC%E4%BC%97%E5%8F%B7.png\",\n\t\t\t        \"keyword\": \"more\"\n\t\t\t    });\n\t\t\t}\n\t\t\t</script>\n\t\t","raw":null,"categories":[{"name":"原创","path":"api/categories/原创.json"},{"name":"原创/科研","path":"api/categories/原创/科研.json"}],"tags":[{"name":"R语言","path":"api/tags/R语言.json"},{"name":"批量","path":"api/tags/批量.json"},{"name":"解压","path":"api/tags/解压.json"},{"name":"实例","path":"api/tags/实例.json"}]},{"title":"RNA-Seq Count数据的标准化(RPKM, FPKM, TPM)-学习笔记","slug":"RNA-Seq Count数据的标准化(RPKM, FPKM, TPM)-学习笔记","date":"2023-09-21T07:37:35.000Z","updated":"2024-10-19T08:32:10.893Z","comments":true,"path":"api/articles/RNA-Seq Count数据的标准化(RPKM, FPKM, TPM)-学习笔记.json","excerpt":null,"keywords":"Hexo, 科研, 生物, R语言, 爬虫, 生信, 中药, 果蝇, 笔记, 教程, 虫子, 潜叶虫, leafminer, leaf-miner, 生活, 随笔, 原创","cover":"https://thereallda.github.io/2022/01/24/%E7%90%86%E8%AE%BA-%E7%AE%80%E8%BF%B0RPKM-FPKM-AND-TPM/image-20220124111816290.png","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><div id=\"vip-container\"><p>测序得到的 <strong>read counts</strong> 数量会受到多种因素的影响，如 <strong>测序深度</strong> 和 <strong>基因长度</strong> 。除了上述两个主要因素外，还会有其他因素对read counts的检测有所影响，例如转录组的组成，GC含量，random hexamers引起的测序偏好等等。因此测序得到的read counts需要标准化后才能进行比较。标准化的方式有 <strong>RPKM</strong> ， <strong>FPKM</strong>， <strong>TPM</strong> 。其中TPM被更多人认可。</p>\n<span id=\"more\"></span> \n<p><strong>RPKM:</strong> Reads per kilo base per million mapped reads (single-end sequencing)</p>\n<p><strong>FPKM:</strong> Fragments per kilo base per million mapped reads (paired-end sequencing)</p>\n<p>RPKM与FPKM实际上一样的单位，只不过RPKM是在单端测序文库中使用，而FPKM是双端测序所用的。对基因长度（gene length）以及测序深度（mapped reads from library）都进行了校正。<br>\n<img data-src=\"https://thereallda.github.io/2022/01/24/%E7%90%86%E8%AE%BA-%E7%AE%80%E8%BF%B0RPKM-FPKM-AND-TPM/image-20220124111816290.png\" alt=\"公式1\"></p>\n<h3 id=\"RPKM，FPKM\">RPKM，FPKM</h3>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#x为一个向量存储了每个基因的counts，而gene.length是相应于x中每个基因的长度的一个向量.</span></span><br><span class=\"line\">RPKM <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">,</span> gene.length<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span> </span><br><span class=\"line\">  lib.size <span class=\"operator\">&lt;-</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span></span><br><span class=\"line\">  rpm <span class=\"operator\">&lt;-</span> 1e6 <span class=\"operator\">*</span> x<span class=\"operator\">/</span>lib.size</span><br><span class=\"line\">  rpkm <span class=\"operator\">&lt;-</span> 1e3 <span class=\"operator\">*</span> rpm<span class=\"operator\">/</span>gene.length</span><br><span class=\"line\">  <span class=\"built_in\">return</span><span class=\"punctuation\">(</span>rpkm<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">FPKM <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">,</span> gene.length<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span> </span><br><span class=\"line\">  lib.size <span class=\"operator\">&lt;-</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span></span><br><span class=\"line\">  rpm <span class=\"operator\">&lt;-</span> 1e6 <span class=\"operator\">*</span> x<span class=\"operator\">/</span>lib.size</span><br><span class=\"line\">  rpkm <span class=\"operator\">&lt;-</span> 1e3 <span class=\"operator\">*</span> rpm<span class=\"operator\">/</span>gene.length</span><br><span class=\"line\">  <span class=\"built_in\">return</span><span class=\"punctuation\">(</span>fpkm<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"TPM\">TPM</h3>\n<p>TPM: Transcript per million<br>\n<img data-src=\"https://thereallda.github.io/2022/01/24/%E7%90%86%E8%AE%BA-%E7%AE%80%E8%BF%B0RPKM-FPKM-AND-TPM/image-20220124111831499.png\" alt=\"公式2\"></p>\n<p>TPM对基因的长度进行了校正，计算比对到基因上的reads/基因长度得到长度校正的表达量 reads per kilobase (RPK)。再以文库中RPK之和作为Scale Factor求出TPM。</p>\n<figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TPM &lt;- function(x, gene.<span class=\"built_in\">length</span>)&#123;</span><br><span class=\"line\">  rpk &lt;- <span class=\"number\">1e3</span> * x/gene.<span class=\"built_in\">length</span></span><br><span class=\"line\">  <span class=\"built_in\">scale</span>.<span class=\"built_in\">factor</span> &lt;- <span class=\"built_in\">sum</span>(rpk)</span><br><span class=\"line\">  tpm &lt;- <span class=\"number\">1e6</span> * rpk/<span class=\"built_in\">scale</span>.<span class=\"built_in\">factor</span></span><br><span class=\"line\">  <span class=\"built_in\">return</span>(tpm)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>相比于RPKM使用文库大小（read counts之和）来作为文库校正因子，TPM使用RPK之和作为文库校正因子的好处是考虑了不同样本间的基因长度的分布。因为RPK是一个对基因长度进行校正后的表达量单位，所以RPK之和也不会再带入基因长度的bias。因此，如果需要比较的样本之间转录本分布不一致时（例如不同物种RNA-seq的比较），使用TPM是一个较佳的normalization方案。</p>\n<p>RPKM和TPM这类方法就是为了使不同样本间的总体表达量趋于一致，让不同样本间的基因表达量有可比较性，而TPM能够更好地校正样本间的差异。</p>\n<p>常用的Normalization 方法总结</p>\n<table>\n<thead>\n<tr>\n<th>Normalization method</th>\n<th>描述</th>\n<th>考虑因素</th>\n<th>使用场景</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CPM (counts per million)</td>\n<td>使用read counts的总和校正counts</td>\n<td>测序深度</td>\n<td>同一样本组重复样本之间的基因counts比较；不适用于样品内的比较或差异分析</td>\n</tr>\n<tr>\n<td>TPM (transcripts per kilobase million)</td>\n<td>每百万mapped reads中每kb转录本上的reads数</td>\n<td>测序深度和基因长度</td>\n<td>样本内或同一样本组样本之间的基因counts比较； 不适用于差异分析</td>\n</tr>\n<tr>\n<td>RPKM/FPKM (reads/fragments per kilobase of exon per million reads/fragments mapped)</td>\n<td>如TPM</td>\n<td>测序深度和基因长度</td>\n<td>样本内基因间的counts比较; 不适用于样本间比较和差异分析</td>\n</tr>\n<tr>\n<td>DESeq2’s median of ratios [1]</td>\n<td>counts除以样本特异的校正因子，该因子由基因计数相对于每个基因的几何平均值的中位数比率确定</td>\n<td>测序深度及RNA组成</td>\n<td>样本之间的基因counts比较以及差异分析; 不适用于样本内比较</td>\n</tr>\n<tr>\n<td>EdgeR’s trimmed mean of M values (TMM) [2]</td>\n<td>使用样本之间的加权截尾的对数表达量比值的均值进行TMM校正</td>\n<td>测序深度，RNA组成以及基因长度</td>\n<td>样品之间和样品内部的基因counts比较，适用于差异分析</td>\n</tr>\n</tbody>\n</table>\n<p>在进行差异表达分析时，我们实际上并不会用到RPKM/FPKM, TPM，而是使用raw counts给到差异分析的工具。这是由于RPKM/FPKM和TPM都没有考虑到样本间文库组成的差异，因而不适合用于样本间差异分析。</p>\n<h2 id=\"获取基因长度\">获取基因长度</h2>\n<p>计算TPM或RPKM/FPKM等基因表达量时，除了基因的counts信息外，我们还需要知道基因的长度。由于可变剪接的存在，一个基因可能会有多个转录本，在进行基因水平的表达分析时，我们并不会区分各个转录本剪接变体的表达量，而是以基因为单位进行统计。目前，对于基因长度有多种定义，包括：</p>\n<ul class=\"lvl-0\">\n<li class=\"lvl-2\">\n<p>基因最长转录本；</p>\n</li>\n<li class=\"lvl-2\">\n<p>多个转录本长度的平均值；</p>\n</li>\n<li class=\"lvl-2\">\n<p>非重叠外显子长度之和：</p>\n</li>\n<li class=\"lvl-2\">\n<p>非重叠CDS序列长度之和。</p>\n</li>\n</ul>\n<p><img data-src=\"https://thereallda.github.io/2022/02/07/R-Retrieve-Gene-Length/paste-CBFC7C07.png\" alt=\"3\"></p>\n<p>Figure Source: Gene structure</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#使用gtf文件在R中获取基因长度（非重叠外显子长度之和）</span><br><span class=\"line\">#首先，读取计算基因counts时用的GTF文件，并将其转换为TxDb对象；</span><br><span class=\"line\">library(GenomicFeatures)</span><br><span class=\"line\">#一般常用的物种基因注释信息都已经有人构建好TxDb对象，以R包的形式上传到Bioconductor里。我们使用时直接加载、赋值即可。BiocManager::install(&quot;TxDb.Dmelanogaster.UCSC.dm6.ensGene&quot;)</span><br><span class=\"line\">#从本地读取数据库文件 txdb &lt;- makeTxDbFromGFF(&#x27;gencode.vM23.annotation.gtf&#x27;, format=&#x27;gtf&#x27;)</span><br><span class=\"line\">#然后，提取每个基因的外显子注释信息；exons.list.per.gene &lt;- exonsBy(txdb, by=&quot;gene&quot;)</span><br><span class=\"line\">library(TxDb.Dmelanogaster.UCSC.dm6.ensGene)</span><br><span class=\"line\">exons.list.per.gene &lt;- exonsBy(TxDb.Dmelanogaster.UCSC.dm6.ensGene, by=&quot;gene&quot;)</span><br><span class=\"line\">#最后，合并重叠的外显子，计算非重叠外显子的长度作为基因长度（bp）</span><br><span class=\"line\">exonic.gene.sizes &lt;- sum(width(reduce(exons.list.per.gene)))</span><br></pre></td></tr></table></figure>\n<p><code>GenomicFeatures</code>还支持自己手动从指定数据库中构建TxDb对象，例如从 UCSC提取构建的<code>makeTxDbFromUCSC()</code>函数；从BioMart提取构建的<code>makeTxDbFromBiomart()</code>函数等方法可以用作替补方案（没有对应TXDB的R包时）。</p>\n<p><code>tureCounts</code>统计基因counts时，其输出的counts.txt文件中通常会包含一列长度信息Length。也是采用非重叠外显子作为基因长度。</p>\n<h2 id=\"参考：\">参考：</h2>\n<ol>\n<li class=\"lvl-3\">\n<p>理论-简述RPKM-FPKM-AND-TPM | Dean’s blog (<span class=\"exturl\" data-url=\"aHR0cDovL3RoZXJlYWxsZGEuZ2l0aHViLmlv\">thereallda.github.io<i class=\"fa fa-external-link-alt\"></i></span>)</p>\n</li>\n<li class=\"lvl-3\">\n<p>R-获取基因长度 | Dean’s blog (<span class=\"exturl\" data-url=\"aHR0cDovL3RoZXJlYWxsZGEuZ2l0aHViLmlv\">thereallda.github.io<i class=\"fa fa-external-link-alt\"></i></span>)</p>\n</li>\n<li class=\"lvl-3\">\n<p>[R]bioconductor之GenomicFeatures学习 - 简书 (<span class=\"exturl\" data-url=\"aHR0cDovL2ppYW5zaHUuY29t\">jianshu.com<i class=\"fa fa-external-link-alt\"></i></span>)</p>\n</li>\n</ol>\n</div>\n\n\t\t\t<script src=\"https://my.openwrite.cn/js/readmore.js\" type=\"text/javascript\"></script>\n\t\t\t<script>\n\t\t\tvar isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);\n\t\t\tif (!isMobile) {\n\t\t\t    var btw = new BTWPlugin();\n\t\t\t    btw.init({\n\t\t\t        \"id\": \"vip-container\",\n\t\t\t        \"blogId\": \"33502-1730425843713-524\",\n\t\t\t        \"name\": \"虫子的生存笔记\",\n\t\t\t        \"qrcode\": \"https://leaf-miner.pages.dev/image/%E5%85%AC%E4%BC%97%E5%8F%B7.png\",\n\t\t\t        \"keyword\": \"more\"\n\t\t\t    });\n\t\t\t}\n\t\t\t</script>\n\t\t","raw":null,"categories":[{"name":"笔记","path":"api/categories/笔记.json"},{"name":"笔记/科研","path":"api/categories/笔记/科研.json"}],"tags":[{"name":"笔记","path":"api/tags/笔记.json"},{"name":"RNA-seq","path":"api/tags/RNA-seq.json"},{"name":"生信","path":"api/tags/生信.json"},{"name":"R语言","path":"api/tags/R语言.json"},{"name":"测序","path":"api/tags/测序.json"},{"name":"标准化","path":"api/tags/标准化.json"}]},{"title":"R语言--爬取小说-战略级天使","slug":"爬取小说--战略级天使","date":"2021-05-03T16:00:00.000Z","updated":"2024-10-18T19:35:20.227Z","comments":true,"path":"api/articles/爬取小说--战略级天使.json","excerpt":null,"keywords":"Hexo, 科研, 生物, R语言, 爬虫, 生信, 中药, 果蝇, 笔记, 教程, 虫子, 潜叶虫, leafminer, leaf-miner, 生活, 随笔, 原创","cover":null,"content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><div id=\"vip-container\"><h2 id=\"目的\">目的</h2>\n<p>小说离线阅读,保存。练习R语言。示例网站：https://www.-----.com/yuedu/15111/</p>\n<span id=\"more\"></span> \n<h2 id=\"实例\">实例</h2>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span><span class=\"string\">&quot;stringr&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span><span class=\"string\">&quot;rvest&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span><span class=\"string\">&#x27;RCurl&#x27;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span><span class=\"string\">&#x27;curl&#x27;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span><span class=\"string\">&#x27;downloader&#x27;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span><span class=\"string\">&#x27;RSelenium&#x27;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">setwd<span class=\"punctuation\">(</span><span class=\"string\">&#x27;H:\\\\R\\\\R脚本\\\\爬虫&#x27;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">url <span class=\"operator\">&lt;-</span> <span class=\"string\">&quot;https://www.-----.com/yuedu/15111/&quot;</span></span><br><span class=\"line\">htmlpage <span class=\"operator\">&lt;-</span> read_html<span class=\"punctuation\">(</span>url<span class=\"punctuation\">)</span></span><br><span class=\"line\">xs_chapter <span class=\"operator\">&lt;-</span> htmlpage <span class=\"operator\">%&gt;%</span> html_nodes<span class=\"punctuation\">(</span><span class=\"string\">&#x27;div#wrapper div.box_con div#list dl dd a&#x27;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> html_text<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>xs_chapter<span class=\"punctuation\">)</span><span class=\"comment\">#观察数据形式</span></span><br><span class=\"line\">xs_link <span class=\"operator\">&lt;-</span> htmlpage <span class=\"operator\">%&gt;%</span> html_nodes<span class=\"punctuation\">(</span><span class=\"string\">&#x27;div#wrapper div.box_con div#list dl dd a&#x27;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> html_attrs<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>xs_link<span class=\"punctuation\">)</span><span class=\"comment\">#观察数据形式</span></span><br><span class=\"line\">xs_link <span class=\"operator\">&lt;-</span> paste<span class=\"punctuation\">(</span><span class=\"string\">&quot;https://www.-----.com&quot;</span><span class=\"punctuation\">,</span>unlist<span class=\"punctuation\">(</span>xs_link<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>sep <span class=\"operator\">=</span> <span class=\"string\">&#x27;&#x27;</span><span class=\"punctuation\">)</span><span class=\"comment\">#构建章节链接</span></span><br><span class=\"line\">xs_content <span class=\"operator\">&lt;-</span> cbind<span class=\"punctuation\">(</span>xs_chapter<span class=\"punctuation\">[</span><span class=\"operator\">-</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">10</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span>xs_link<span class=\"punctuation\">[</span><span class=\"operator\">-</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">10</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"comment\">#合并目录链接</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#尝试获取小说内容，并提取。</span></span><br><span class=\"line\">ms_f1 <span class=\"operator\">&lt;-</span> read_html<span class=\"punctuation\">(</span>xs_content<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"punctuation\">,</span><span class=\"number\">2</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> encoding <span class=\"operator\">=</span> <span class=\"string\">&quot;GB18030&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> html_nodes<span class=\"punctuation\">(</span><span class=\"string\">&#x27;div#content&#x27;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> html_text<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">ms_f2 <span class=\"operator\">&lt;-</span> read_html<span class=\"punctuation\">(</span>xs_content<span class=\"punctuation\">[</span><span class=\"number\">2</span><span class=\"punctuation\">,</span><span class=\"number\">2</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> encoding <span class=\"operator\">=</span> <span class=\"string\">&quot;GB18030&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> html_nodes<span class=\"punctuation\">(</span><span class=\"string\">&#x27;div#content&#x27;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> html_text<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">ms_f <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>xs_content<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"punctuation\">,</span><span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span>ms_f1<span class=\"punctuation\">,</span>xs_content<span class=\"punctuation\">[</span><span class=\"number\">2</span><span class=\"punctuation\">,</span><span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span>ms_f2<span class=\"punctuation\">)</span></span><br><span class=\"line\">write<span class=\"punctuation\">(</span>gsub<span class=\"punctuation\">(</span><span class=\"string\">&quot;\\u00A0&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot; &quot;</span><span class=\"punctuation\">,</span> ms_f<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>file <span class=\"operator\">=</span> <span class=\"string\">&quot;1.txt&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#自定义下载函数</span></span><br><span class=\"line\">xs_down <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  xs <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> <span class=\"punctuation\">(</span>i <span class=\"keyword\">in</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"built_in\">length</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span><span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  xm <span class=\"operator\">&lt;-</span> read_html<span class=\"punctuation\">(</span>x<span class=\"punctuation\">[</span>i<span class=\"punctuation\">,</span><span class=\"number\">2</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> encoding <span class=\"operator\">=</span> <span class=\"string\">&quot;GB18030&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> html_nodes<span class=\"punctuation\">(</span><span class=\"string\">&#x27;div#content&#x27;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> html_text<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  xs <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>xs<span class=\"punctuation\">,</span> x<span class=\"punctuation\">[</span>i<span class=\"punctuation\">,</span><span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> xm<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  xs</span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#导出小说</span></span><br><span class=\"line\">write<span class=\"punctuation\">(</span>gsub<span class=\"punctuation\">(</span><span class=\"string\">&quot;\\u00A0&quot;</span><span class=\"punctuation\">,</span><span class=\"string\">&quot; &quot;</span><span class=\"punctuation\">,</span> xs_down<span class=\"punctuation\">(</span>xs_content<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span>file <span class=\"operator\">=</span> <span class=\"string\">&quot;战略级天使.txt&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></div>\n\n\t\t\t<script src=\"https://my.openwrite.cn/js/readmore.js\" type=\"text/javascript\"></script>\n\t\t\t<script>\n\t\t\tvar isMobile = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);\n\t\t\tif (!isMobile) {\n\t\t\t    var btw = new BTWPlugin();\n\t\t\t    btw.init({\n\t\t\t        \"id\": \"vip-container\",\n\t\t\t        \"blogId\": \"33502-1730425843713-524\",\n\t\t\t        \"name\": \"虫子的生存笔记\",\n\t\t\t        \"qrcode\": \"https://leaf-miner.pages.dev/image/%E5%85%AC%E4%BC%97%E5%8F%B7.png\",\n\t\t\t        \"keyword\": \"more\"\n\t\t\t    });\n\t\t\t}\n\t\t\t</script>\n\t\t","raw":null,"categories":[{"name":"原创","path":"api/categories/原创.json"},{"name":"原创/其他","path":"api/categories/原创/其他.json"}],"tags":[{"name":"R语言","path":"api/tags/R语言.json"},{"name":"实例","path":"api/tags/实例.json"},{"name":"爬虫","path":"api/tags/爬虫.json"},{"name":"小说","path":"api/tags/小说.json"}]}]}